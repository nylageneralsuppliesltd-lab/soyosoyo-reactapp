generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // NO url or directUrl here anymore in Prisma 7+
}

// Your models below (Member, Ledger, history, sacco_history) â€“ unchanged
model Member {
  id                 Int       @id @default(autoincrement())
  name               String
  phone              String    @unique
  email              String?
  idNumber           String?
  dob                DateTime?
  gender             String?
  physicalAddress    String?
  town               String?
  employmentStatus   String?
  employerName       String?
  regNo              String?
  employerAddress    String?
  role               String
  introducerName     String
  introducerMemberNo String
  balance            Float     @default(0)
  active             Boolean   @default(true)
  ledger             Ledger[]  
  deposits           Deposit[]
  withdrawals        Withdrawal[]
  loans              Loan[]
  nextOfKin          Json?     
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

model Ledger {
  id           Int       @id @default(autoincrement())
  member       Member    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  memberId     Int
  type         String
  amount       Float
  description  String?
  balanceAfter Float
  date         DateTime  @default(now())
}

model history {
  id                 Int       @id @default(autoincrement())
  period             DateTime  @unique(map: "idx_history_period") @db.Date
  members            Int?      @default(0)
  contributions      Decimal?  @default(0.00) @db.Decimal(15, 2)
  loans_disbursed    Decimal?  @default(0.00) @db.Decimal(15, 2)
  loans_balance      Decimal?  @default(0.00) @db.Decimal(15, 2)
  total_bank_balance Decimal?  @default(0.00) @db.Decimal(15, 2)
  coop_bank          Decimal?  @default(0.00) @db.Decimal(15, 2)
  chama_soft         Decimal?  @default(0.00) @db.Decimal(15, 2)
  cytonn             Decimal?  @default(0.00) @db.Decimal(15, 2)
  total_assets       Decimal?  @default(0.00) @db.Decimal(15, 2)
  profit             Decimal?  @default(0.00) @db.Decimal(15, 2)
  roa                Decimal?  @default(0.00) @db.Decimal(5, 2)
  date_saved         DateTime? @default(now()) @db.Timestamp(6)
  extra_fields       Json?     @default("{}")
}

model sacco_history {
  id                 Int       @id @default(autoincrement())
  members            Int?
  contributions      Decimal?  @db.Decimal(15, 2)
  loans_balance      Decimal?  @db.Decimal(15, 2)
  total_bank_balance Decimal?  @db.Decimal(15, 2)
  roa                Decimal?  @db.Decimal(6, 2)
  date_saved         DateTime? @default(dbgenerated("CURRENT_DATE")) @db.Timestamp(6)
  loans_disbursed    Decimal?  @default(0) @db.Decimal(15, 2)
  profit             Decimal?  @default(0) @db.Decimal(15, 2)
  coop_bank          Decimal?  @default(0) @db.Decimal(15, 2)
  chama_soft         Decimal?  @default(0) @db.Decimal(15, 2)
  cytonn             Decimal?  @default(0) @db.Decimal(15, 2)
  total_assets       Decimal?  @default(0) @db.Decimal(15, 2)
  extra_fields       Json?     @default("{}")
  period             DateTime? @unique @db.Date
}

enum PaymentMethod {
  cash
  bank
  mpesa
  other
}

enum LoanStatus {
  Active
  Closed
  Defaulted
}

model Deposit {
  id         Int            @id @default(autoincrement())
  member     Member?        @relation(fields: [memberId], references: [id], onDelete: SetNull)
  memberId   Int?
  memberName String
  amount     Decimal        @db.Decimal(14, 2)
  method     PaymentMethod  @default(cash)
  reference  String?
  notes      String?
  date       DateTime       @db.Date
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  @@index([memberId])
  @@index([date])
}

model Withdrawal {
  id         Int            @id @default(autoincrement())
  member     Member?        @relation(fields: [memberId], references: [id], onDelete: SetNull)
  memberId   Int?
  memberName String
  amount     Decimal        @db.Decimal(14, 2)
  method     PaymentMethod  @default(cash)
  purpose    String?
  notes      String?
  date       DateTime       @db.Date
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  @@index([memberId])
  @@index([date])
}

model Loan {
  id           Int           @id @default(autoincrement())
  borrower     Member?       @relation(fields: [borrowerId], references: [id], onDelete: SetNull)
  borrowerId   Int?
  borrowerName String
  amount       Decimal       @db.Decimal(14, 2)
  rate         Decimal?      @db.Decimal(5, 2)
  termMonths   Int?
  startDate    DateTime      @db.Date
  status       LoanStatus    @default(Active)
  purpose      String?
  repayments   Repayment[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([borrowerId])
  @@index([status])
}

model Repayment {
  id        Int           @id @default(autoincrement())
  loan      Loan          @relation(fields: [loanId], references: [id], onDelete: Cascade)
  loanId    Int
  amount    Decimal       @db.Decimal(14, 2)
  method    PaymentMethod @default(cash)
  notes     String?
  date      DateTime      @db.Date
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@index([loanId])
  @@index([date])
}
