generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============== ENUMS ==============
enum PaymentMethod {
  cash
  bank
  mpesa
  check_off
  bank_deposit
  other
}

enum LoanStatus {
  pending
  active
  closed
  defaulted
}

enum LoanDirection {
  outward
  inward
}

enum TransactionType {
  contribution
  income
  fine
  loan_repayment
  expense
  dividend
  refund
  transfer
  loan_disbursement
}

enum AccountType {
  cash
  pettyCash
  mobileMoney
  bank
  gl
}

enum FineType {
  late_payment
  absenteeism
  rule_violation
  other
}

enum PermissionType {
  view_members
  edit_members
  record_deposits
  record_withdrawals
  approve_loans
  view_reports
  manage_settings
  manage_roles
  view_ledger
}

// ============== CORE MODELS ==============
model Member {
  id                 Int       @id @default(autoincrement())
  name               String
  phone              String    @unique
  email              String?
  idNumber           String?
  dob                DateTime?
  gender             String?
  physicalAddress    String?
  town               String?
  employmentStatus   String?
  employerName       String?
  regNo              String?
  employerAddress    String?
  role               String?
  introducerName     String?
  introducerMemberNo String?
  balance            Float     @default(0)
  loanBalance        Float     @default(0)
  active             Boolean   @default(true)
  
  ledger             Ledger[]  
  deposits           Deposit[]
  withdrawals        Withdrawal[]
  loans              Loan[]
  repayments         Repayment[]
  fines              Fine[]
  invoices           MemberInvoice[]
  
  nextOfKin          Json?     
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

model Ledger {
  id           Int       @id @default(autoincrement())
  member       Member    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  memberId     Int
  type         String
  amount       Float
  description  String?
  reference    String?
  balanceAfter Float
  date         DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  // Link to invoice that triggered this ledger entry
  memberInvoice MemberInvoice? @relation("InvoiceLedger", fields: [memberInvoiceId], references: [id], onDelete: SetNull)
  memberInvoiceId Int?

  @@index([memberInvoiceId])
}
// ============== SETTINGS & CONFIGURATION ==============
model ContributionType {
  id                  Int       @id @default(autoincrement())
  name                String    @unique
  description         String?
  amount              Decimal   @db.Decimal(14, 2)
  frequency           String?   // Monthly, Weekly, Quarterly
  typeCategory        String?   // Regular, OneTime
  dayOfMonth          String?
  invoiceDate         DateTime? @db.Date
  dueDate             DateTime? @db.Date
  smsNotifications    Boolean   @default(true)
  emailNotifications  Boolean   @default(false)
  finesEnabled        Boolean   @default(false)
  lateFineEnabled     Boolean   @default(false)
  lateFineAmount      Decimal   @default(0) @db.Decimal(14, 2)
  lateFineGraceDays   Int       @default(0)
  invoiceAllMembers   Boolean   @default(true)
  visibleInvoicing    Boolean   @default(true)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  // Relationship to generated invoices
  memberInvoices      MemberInvoice[]
}

model ExpenseCategory {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  description String?
  isAdmin     Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Link to auto-created ledger for this category
  categoryLedger CategoryLedger? @relation("ExpenseCategoryLedger")
}

model IncomeCategory {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Link to auto-created ledger for this category
  categoryLedger CategoryLedger? @relation("IncomeCategoryLedger")
}

model CategoryLedger {
  id               Int       @id @default(autoincrement())
  categoryType     String    // 'income' or 'expense'
  categoryName     String    @unique
  
  // Relations to categories
  expenseCategory  ExpenseCategory? @relation("ExpenseCategoryLedger", fields: [expenseCategoryId], references: [id], onDelete: Cascade)
  expenseCategoryId Int? @unique
  
  incomeCategory   IncomeCategory? @relation("IncomeCategoryLedger", fields: [incomeCategoryId], references: [id], onDelete: Cascade)
  incomeCategoryId Int? @unique
  
  // Ledger totals
  totalAmount      Decimal   @default(0) @db.Decimal(14, 2)
  balance          Decimal   @default(0) @db.Decimal(14, 2)
  
  // Entries posted to this ledger
  entries          CategoryLedgerEntry[]
  
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  @@index([categoryType])
  @@index([categoryName])
}

model CategoryLedgerEntry {
  id               Int       @id @default(autoincrement())
  categoryLedger   CategoryLedger @relation(fields: [categoryLedgerId], references: [id], onDelete: Cascade)
  categoryLedgerId Int
  
  type             String    // 'debit', 'credit', 'transfer'
  amount           Decimal   @db.Decimal(14, 2)
  description      String?
  narration        String?
  reference        String?
  
  // Source information
  sourceType       String?   // 'deposit', 'withdrawal', 'manual_journal', 'transfer', 'invoice'
  sourceId         String?   // Reference ID to source transaction
  
  balanceAfter     Decimal   @db.Decimal(14, 2)
  
  date             DateTime  @default(now())
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  @@index([categoryLedgerId])
  @@index([date])
  @@index([sourceType])
}

model FineCategory {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model GroupRole {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  description String?
  permissions Json?     // Store as JSON array of permission strings
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Account {
  id             Int         @id @default(autoincrement())
  type           AccountType
  name           String      @unique
  description    String?
  
  // Bank Account fields
  bankName       String?
  branch         String?
  accountName    String?
  accountNumber  String?
  
  // Mobile Money fields
  provider       String?
  number         String?
  
  // Common fields
  balance        Decimal     @default(0) @db.Decimal(14, 2)
  currency       String      @default("KES")
  isActive       Boolean     @default(true)
  
  journalEntries JournalEntry[] @relation("DebitAccount")
  creditEntries  JournalEntry[] @relation("CreditAccount")
  deposits       Deposit[]   @relation("DepositAccount")
  withdrawals    Withdrawal[] @relation("WithdrawalAccount")
  assetPurchases Asset[]     @relation("AssetPurchaseAccount")
  assetDisposals Asset[]     @relation("AssetDisposalAccount")
  assetTransactions AssetTransaction[] @relation("AssetTransactionAccount")
  
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
}

// ============== FINANCIAL TRANSACTIONS ==============
model Deposit {
  id           Int             @id @default(autoincrement())
  member       Member?         @relation(fields: [memberId], references: [id], onDelete: SetNull)
  memberId     Int?
  memberName   String?
  type         TransactionType @default(contribution)
  category     String?
  amount       Decimal         @db.Decimal(14, 2)
  account      Account?        @relation("DepositAccount", fields: [accountId], references: [id], onDelete: SetNull)
  accountId    Int?
  method       PaymentMethod   @default(cash)
  reference    String?
  notes        String?
  description  String?
  narration    String?
  date         DateTime        @db.Date
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  @@index([memberId])
  @@index([date])
  @@index([type])
}

model Withdrawal {
  id           Int             @id @default(autoincrement())
  member       Member?         @relation(fields: [memberId], references: [id], onDelete: SetNull)
  memberId     Int?
  memberName   String?
  type         TransactionType @default(expense)
  category     String?
  amount       Decimal         @db.Decimal(14, 2)
  description  String?
  narration    String?
  reference    String?
  method       PaymentMethod   @default(cash)
  account      Account?        @relation("WithdrawalAccount", fields: [accountId], references: [id], onDelete: SetNull)
  accountId    Int?
  purpose      String?
  notes        String?
  date         DateTime        @db.Date
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  @@index([memberId])
  @@index([date])
  @@index([type])
}

// ============== LOANS ==============
model LoanType {
  id                    Int       @id @default(autoincrement())
  name                  String    @unique
  description           String?
  maxAmount             Decimal?  @db.Decimal(14, 2)
  maxMultiple           Decimal?  @db.Decimal(5, 2)
  periodMonths          Int       @default(12)
  interestRate          Decimal   @db.Decimal(5, 2)
  interestType          String    @default("flat") // flat, reducing, fixed
  interestFrequency     String?   // monthly, weekly, daily, yearly
  periodFlexible        String?   // fixed, flexible
  gracePeriod           Int?      // months
  qualificationCriteria String?   // qualification criteria
  approvers             String?   // approvers
  fineFrequency         String?   // monthly, weekly, daily, yearly
  fineBase              String?   // total-unpaid, loan-amount, installment-balance, installment-interest
  autoDisbursement      Boolean?  @default(false)
  processingFee         Decimal?  @db.Decimal(14, 2)
  processingFeeType     String?   // fixed, percentage
  guarantorsRequired    Boolean?  @default(false)
  guarantorName         String?
  guarantorAmount       Decimal?  @db.Decimal(14, 2)
  guarantorNotified     Boolean?  @default(false)
  lateFinesEnabled      Boolean   @default(false)
  lateFinesType         String?   // one-off, fixed, percentage
  lateFinesValue        Decimal?  @db.Decimal(5, 2)
  outstandingFinesEnabled Boolean @default(false)
  outstandingFinesType  String?
  outstandingFinesValue Decimal?  @db.Decimal(5, 2)
  
  loans                 Loan[]
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

model Loan {
  id                Int             @id @default(autoincrement())
  member            Member?         @relation(fields: [memberId], references: [id], onDelete: SetNull)
  memberId          Int?
  memberName        String?
  externalName      String?
  bankName          String?         // For inward loans
  contactPerson     String?
  amount            Decimal         @db.Decimal(14, 2)
  balance           Decimal         @db.Decimal(14, 2)
  interestRate      Decimal         @db.Decimal(5, 2)
  interestType      String          @default("flat")
  interestFrequency String?         // monthly, weekly, daily, yearly
  periodFlexible    String?         // fixed, flexible
  gracePeriod       Int?            // months
  qualificationCriteria String?     // qualification criteria
  approvers         String?         // approvers
  fineFrequency     String?         // monthly, weekly, daily, yearly
  fineBase          String?         // total-unpaid, loan-amount, installment-balance, installment-interest
  autoDisbursement  Boolean?        @default(false)
  processingFee     Decimal?        @db.Decimal(14, 2)
  processingFeeType String?         // fixed, percentage
  guarantorsRequired Boolean?       @default(false)
  guarantorName     String?
  guarantorAmount   Decimal?        @db.Decimal(14, 2)
  guarantorNotified Boolean?        @default(false)
  periodMonths      Int
  status            LoanStatus      @default(pending)
  loanDirection     LoanDirection   @default(outward)
  schedule          Json?           // Amortization schedule
  disbursementDate  DateTime?       @db.Date
  disbursementAccount String?
  startDate         DateTime?       @db.Date
  dueDate           DateTime?       @db.Date
  purpose           String?
  terms             String?
  collateral        String?
  classification    String?         // IFRS 9: amortized_cost, FVPL, FVOCI
  impairment        Decimal?        @db.Decimal(14, 2) // IFRS 9: impairment loss
  ecl               Decimal?        @db.Decimal(14, 2) // IFRS 9: expected credit loss
  notes             String?         // For disclosures

  repayments        Repayment[]
  fines             Fine[]

  loanType          LoanType?       @relation(fields: [loanTypeId], references: [id], onDelete: SetNull)
  loanTypeId        Int?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([memberId])
  @@index([status])
  @@index([loanDirection])
}

// ============== IFRS DISCLOSURE NOTES ==============
model DisclosureNote {
  id          Int      @id @default(autoincrement())
  title       String
  content     String
  relatedType String? // loan, asset, liability, equity, etc.
  relatedId   Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Repayment {
  id           Int       @id @default(autoincrement())
  loan         Loan      @relation(fields: [loanId], references: [id], onDelete: Cascade)
  loanId       Int
  member       Member?   @relation(fields: [memberId], references: [id], onDelete: SetNull)
  memberId     Int?
  
  amount       Decimal   @db.Decimal(14, 2)
  principal    Decimal   @default(0) @db.Decimal(14, 2)
  interest     Decimal   @default(0) @db.Decimal(14, 2)
  
  method       PaymentMethod @default(cash)
  reference    String?
  notes        String?
  date         DateTime  @db.Date
  
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([loanId])
  @@index([memberId])
  @@index([date])
}

// ============== FINES & PENALTIES ==============
model Fine {
  id           Int       @id @default(autoincrement())
  member       Member    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  memberId     Int
  loan         Loan?     @relation(fields: [loanId], references: [id], onDelete: SetNull)
  loanId       Int?
  memberInvoice MemberInvoice? @relation(fields: [memberInvoiceId], references: [id], onDelete: SetNull)
  memberInvoiceId Int?
  
  type         FineType
  reason       String?
  amount       Decimal   @db.Decimal(14, 2)
  
  status       String    @default("unpaid") // unpaid, partial, paid
  paidAmount   Decimal   @default(0) @db.Decimal(14, 2)
  
  dueDate      DateTime? @db.Date
  paidDate     DateTime? @db.Date
  notes        String?
  
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([memberId])
  @@index([status])
  @@index([memberInvoiceId])
  @@unique([memberId, memberInvoiceId], name: "unique_member_invoice_fine")
}

model JournalEntry {
  id             Int      @id @default(autoincrement())
  date           DateTime @db.Date
  reference      String?
  description    String
  narration      String?
  
  debitAccount   Account  @relation("DebitAccount", fields: [debitAccountId], references: [id], onDelete: Restrict)
  debitAccountId Int
  debitAmount    Decimal  @db.Decimal(14, 2)
  
  creditAccount  Account? @relation("CreditAccount", fields: [creditAccountId], references: [id], onDelete: SetNull)
  creditAccountId Int?
  creditAmount   Decimal  @db.Decimal(14, 2)
  
  category       String?
  memo           String?
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([date])
  @@index([reference])
}

// ============== ASSETS ==============
model Asset {
  id              Int       @id @default(autoincrement())
  name            String
  description     String?
  category        String    // Equipment, Vehicle, Building, Furniture, etc.
  
  // Purchase details
  purchasePrice   Decimal   @db.Decimal(14, 2)
  purchaseDate    DateTime  @db.Date
  purchaseAccount Account?  @relation("AssetPurchaseAccount", fields: [purchaseAccountId], references: [id], onDelete: SetNull)
  purchaseAccountId Int?
  
  // Current value
  currentValue    Decimal   @db.Decimal(14, 2)
  depreciationRate Decimal? @db.Decimal(5, 2) // Annual depreciation percentage
  lastValueUpdate DateTime? @db.Date
  
  // Disposal/Selling
  status          String    @default("active")      // active, sold, disposed, damaged
  disposalDate    DateTime? @db.Date
  disposalPrice   Decimal?  @db.Decimal(14, 2)
  disposalAccount Account?  @relation("AssetDisposalAccount", fields: [disposalAccountId], references: [id], onDelete: SetNull)
  disposalAccountId Int?
  disposalReason  String?
  
  // Tracking
  transactions    AssetTransaction[]
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([category])
  @@index([status])
  @@index([purchaseDate])
}

model AssetTransaction {
  id              Int       @id @default(autoincrement())
  asset           Asset     @relation(fields: [assetId], references: [id], onDelete: Cascade)
  assetId         Int
  
  type            String    // 'purchase', 'sale', 'depreciation', 'adjustment'
  amount          Decimal   @db.Decimal(14, 2)
  
  // Account affected
  account         Account?  @relation("AssetTransactionAccount", fields: [accountId], references: [id], onDelete: SetNull)
  accountId       Int?
  accountName     String?   // Cached account name (cash, mpesa, bank, etc.)
  accountType     String?   // Cached account type
  
  description     String?
  reference       String?
  notes           String?
  
  // For sales transactions
  gainLoss        Decimal?  @db.Decimal(14, 2)  // Difference between disposal price and current value
  
  date            DateTime  @default(now())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([assetId])
  @@index([type])
  @@index([date])
  @@index([accountId])
}

// ============== INVOICE TEMPLATES ==============
model InvoiceTemplate {
  id            Int       @id @default(autoincrement())
  type          String
  sendTo        String    // All Members, Active Only, Specific Members
  amount        Decimal   @db.Decimal(14, 2)
  invoiceDate   DateTime  @db.Date
  dueDate       DateTime  @db.Date
  description   String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// ============== MEMBER INVOICES (Auto-generated from Contribution Types) ==============
model MemberInvoice {
  id                    Int           @id @default(autoincrement())
  member                Member        @relation(fields: [memberId], references: [id], onDelete: Cascade)
  memberId              Int
  contributionType      ContributionType? @relation(fields: [contributionTypeId], references: [id], onDelete: SetNull)
  contributionTypeId    Int?
  
  invoiceNumber         String        @unique
  amount                Decimal       @db.Decimal(14, 2)
  invoiceDate           DateTime      @db.Date
  dueDate               DateTime      @db.Date
  
  status                String        @default("sent")      // sent, viewed, paid, overdue, cancelled
  paidAmount            Decimal       @default(0) @db.Decimal(14, 2)
  paidDate              DateTime?     @db.Date
  
  smsNotificationSent   Boolean       @default(false)
  emailNotificationSent Boolean       @default(false)
  notificationSentAt    DateTime?
  
  description           String?
  notes                 String?
  
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  
  ledgerEntries         Ledger[]      @relation("InvoiceLedger")
  fines                 Fine[]
  logs                  InvoiceLog[]

  @@index([memberId])
  @@index([invoiceDate])
  @@index([dueDate])
  @@index([status])
}

// ============== INVOICE LOG (Audit Trail) ==============
model InvoiceLog {
  id                    String        @id @default(cuid())
  memberInvoice         MemberInvoice @relation(fields: [memberInvoiceId], references: [id], onDelete: Cascade)
  memberInvoiceId       Int
  
  action                String        // generated, sent_sms, sent_email, paid, overdue_reminder
  status                String        // success, failed, pending
  details               Json?         // Error details, delivery status, etc.
  
  createdAt             DateTime      @default(now())
  
  @@index([memberInvoiceId])
  @@index([action])
  @@index([createdAt])
}

model history {
  id                 Int       @id @default(autoincrement())
  period             DateTime  @unique(map: "idx_history_period") @db.Date
  members            Int?      @default(0)
  contributions      Decimal?  @default(0.00) @db.Decimal(15, 2)
  loans_disbursed    Decimal?  @default(0.00) @db.Decimal(15, 2)
  loans_balance      Decimal?  @default(0.00) @db.Decimal(15, 2)
  total_bank_balance Decimal?  @default(0.00) @db.Decimal(15, 2)
  coop_bank          Decimal?  @default(0.00) @db.Decimal(15, 2)
  chama_soft         Decimal?  @default(0.00) @db.Decimal(15, 2)
  cytonn             Decimal?  @default(0.00) @db.Decimal(15, 2)
  total_assets       Decimal?  @default(0.00) @db.Decimal(15, 2)
  profit             Decimal?  @default(0.00) @db.Decimal(15, 2)
  roa                Decimal?  @default(0.00) @db.Decimal(5, 2)
  date_saved         DateTime? @default(now()) @db.Timestamp(6)
  extra_fields       Json?     @default("{}")
}

model sacco_history {
  id                 Int       @id @default(autoincrement())
  members            Int?
  contributions      Decimal?  @db.Decimal(15, 2)
  loans_balance      Decimal?  @db.Decimal(15, 2)
  total_bank_balance Decimal?  @db.Decimal(15, 2)
  roa                Decimal?  @db.Decimal(6, 2)
  date_saved         DateTime? @default(dbgenerated("CURRENT_DATE")) @db.Timestamp(6)
  loans_disbursed    Decimal?  @default(0) @db.Decimal(15, 2)
  profit             Decimal?  @default(0) @db.Decimal(15, 2)
  coop_bank          Decimal?  @default(0) @db.Decimal(15, 2)
  chama_soft         Decimal?  @default(0) @db.Decimal(15, 2)
  cytonn             Decimal?  @default(0) @db.Decimal(15, 2)
  total_assets       Decimal?  @default(0) @db.Decimal(15, 2)
  extra_fields       Json?     @default("{}")
  period             DateTime? @unique @db.Date
}

// ============== AUDIT LOG ==============
model AuditLog {
  id         String   @id @default(cuid())
  actor      String   @db.Text
  action     String
  resource   String
  resourceId String?
  ip         String?
  userAgent  String?
  payload    Json?
  createdAt  DateTime @default(now())

  @@map("AuditLog")
}

// ============== IFRS CONFIG & RUNS ==============
model IFRSConfig {
  id        Int     @id @default(autoincrement())
  key       String  @unique
  value     String  // JSON encoded value for flexibility
  description String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EclRun {
  id          Int      @id @default(autoincrement())
  runAt       DateTime @default(now())
  operator    String?  // user or system that triggered the run
  dryRun      Boolean  @default(true)
  loanCount   Int?     // loans considered
  totalEcl    Decimal? @db.Decimal(18, 6)
  notes       String?
  createdAt   DateTime @default(now())
}
